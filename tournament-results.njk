---
permalink: "tournament-results/"
pageClass: "page-tournament-results"
---
{% extends "layout.njk" %}

{% block page_header %}
{% endblock %}

{% block title %}Tournament Results | FGC Player Rankings{% endblock %}

{% block head %}
<meta name="description" content="Official tournament results for Fighting Game Community (FGC) Street Fighter tournaments. Browse player finishes, view event dates, and filter by player name or event.">
<style>
/* Local styles for this page's features */
mark {
  background-color: #FFEE58;
  color: #222;
  padding: 0 2px;
  border-radius: 3px;
}
.skeleton td {
  background-color: #2a2a2a;
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}
.skeleton td::after {
  content: '';
  position: absolute;
  top: 0;
  left: -150%;
  width: 150%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
  animation: shimmer 1.5s infinite;
}
@keyframes shimmer { 100% { left: 150%; } }

/* ---- Sticky behaviors ---- */
.table-wrapper { overflow-x: auto; }

/* Desktop/tablet: thead sticks inside scroll container */
@media (min-width: 769px) {
  .data-table th {
    position: sticky;
    top: 0;
    background: #1e1e1e;
    z-index: 10;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="content-container content-container--wide">
  {% include "banner.njk" %}
  <h1>Tournament Results</h1>

  
<div class="tournament-nav">
    <button id="sticky-prev-btn" class="btn btn--primary">&leftarrow; Prev Event</button>
    <select id="event-select-dropdown" class="event-select" aria-label="Select an event"></select>
    <button id="sticky-next-btn" class="btn btn--primary">Next Event &rightarrow;</button>
  </div>

  <!-- Mobile sticky sort bar moved OUTSIDE controls-container -->
  <div class="mobile-sort-controls" id="results-mobile-sort">
    <button class="btn btn--primary" data-column-name="Event" data-type="string">
      Event
      <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
      </svg>
    </button>
    <button class="btn btn--primary" data-column-name="Player" data-type="string">
      Player
      <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
      </svg>
    </button>
    <button class="btn btn--primary sorted asc" data-column-name="Finish" data-type="finish">
      Finish
      <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
      </svg>
    </button>
  </div>

  <div class="controls-container">
    <div class="search-wrapper">
      <input type="text" id="search-input" class="search-form__input" placeholder="Search by Player or Event...">
      <button class="search-clear-btn" id="search-clear-btn" aria-label="Clear search">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="data-table" id="tournament-results-table">
      <thead>
        <tr>
          <th data-column-name="Event" data-type="string">
            <span>Event
              <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
              </svg>
            </span>
          </th>
          <th data-column-name="Date" data-type="string">
            <span>Date
              <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
              </svg>
            </span>
          </th>
          <th data-column-name="Entrants" data-type="number">
            <span>Entrants
              <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
              </svg>
            </span>
          </th>
          <th data-column-name="Player" data-type="string">
            <span>Player
              <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
              </svg>
            </span>
          </th>
          <th data-column-name="Finish" data-type="finish" class="sorted asc">
            <span>Finish
              <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 5V19"/><path d="M19 12L12 19L5 12"/>
              </svg>
            </span>
          </th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

  <div class="load-more-container">
    <button id="results-load-more-btn" class="btn btn--primary" style="display:none;">Load More</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Entire existing tournament-results JS remains here (no change needed)
// Ensure updateStickyOffsets() runs on resize/orientation
// Mobile sticky now works because #results-mobile-sort is outside controls-container
document.addEventListener('DOMContentLoaded', () => {
  function updateStickyOffsets() {
    const mobileHeader = document.querySelector('.mobile-header');
    const nav = document.querySelector('.tournament-nav');
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    let offset = 0;
    if (isMobile) {
      if (mobileHeader) offset += mobileHeader.offsetHeight || 0;
      if (nav) offset += nav.offsetHeight || 0;
    }
    document.documentElement.style.setProperty('--mobile-sticky-offset', offset + 'px');
  }
  updateStickyOffsets();
  window.addEventListener('resize', updateStickyOffsets);
  window.addEventListener('orientationchange', updateStickyOffsets);

  /* ---------------- Existing page logic ---------------- */
  const tournamentTable = document.getElementById('tournament-results-table');
  if (!tournamentTable) return;

  // --- ELEMENT SELECTORS ---
  const tableBody = tournamentTable.querySelector('tbody');
  const searchInput = document.getElementById('search-input');
  const stickyPrevBtn = document.getElementById('sticky-prev-btn');
  const stickyNextBtn = document.getElementById('sticky-next-btn');
  const eventDropdown = document.getElementById('event-select-dropdown');
  const loadMoreBtn = document.getElementById('results-load-more-btn');

  // --- DATA & STATE VARIABLES ---
  const googleSheetURL   = "https://docs.google.com/spreadsheets/d/1otrfs8HN3Shq6U2-qrc4GDxTI4ragnqwbTjweecE12Q/gviz/tq?tqx=out:csv&gid=1021048964";
  const googleRankingsURL= "https://docs.google.com/spreadsheets/d/1otrfs8HN3Shq6U2-qrc4GDxTI4ragnqwbTjweecE12Q/gviz/tq?tqx=out:csv&gid=1862929315";

  let allData = [];
  let groupedDataByEvent = {};
  let uniqueEvents = [];
  let currentEventIndex = 0;
  let searchTerm = '';
  let sortedColumn = 'Finish';
  let sortDirection = 'asc';
  let rankingsMap = {};
  let playerIconMap = {};

  // --- State for "Load More" functionality ---
  const playersPerLoad = 16;
  let visiblePlayers = playersPerLoad;

  const initialSortHeader = document.querySelector('#tournament-results-table th.sorted');
  if (initialSortHeader) {
    sortedColumn = initialSortHeader.getAttribute('data-column-name');
    sortDirection = initialSortHeader.classList.contains('desc') ? 'desc' : 'asc';
  }

  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  function showSkeletonLoader() {
    let skeletonHtml = '';
    const rowCount = window.innerWidth < 769 ? playersPerLoad : 10;
    for (let i = 0; i < rowCount; i++) {
      skeletonHtml += '<tr class="skeleton"><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>';
    }
    tableBody.innerHTML = skeletonHtml;
  }

  function populateEventDropdown() {
    if (!eventDropdown) return;
    eventDropdown.innerHTML = '';
    uniqueEvents.forEach((eventName, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = eventName;
      eventDropdown.appendChild(option);
    });
  }

  function sortData(data, column, type, direction) {
    if (!data || !column) return data;
    const order = direction === 'asc' ? 1 : -1;

    return [...data].sort((a, b) => {
      const valA = a[column];
      const valB = b[column];

      if (type === 'finish') {
        const numA = parseFloat(String(valA).replace(/(st|nd|rd|th)/, ''));
        const numB = parseFloat(String(valB).replace(/(st|nd|rd|th)/, ''));
        if (!isNaN(numA) && !isNaN(numB)) {
          const finishComparison = (numA - numB);
          if (finishComparison !== 0) return finishComparison * order;
          const dateA = new Date(a.Date);
          const dateB = new Date(b.Date);
          return (dateB - dateA);
        }
      } else if (type === 'number') {
        const numA = parseFloat(valA) || 0;
        const numB = parseFloat(valB) || 0;
        return (numA - numB) * order;
      }

      const strA = String(valA).toLowerCase();
      const strB = String(valB).toLowerCase();
      if (strA < strB) return -1 * order;
      if (strA > strB) return 1 * order;
      return 0;
    });
  }

  async function fetchData() {
    try {
      if (eventDropdown) eventDropdown.innerHTML = '<option>Loading Events...</option>';
      showSkeletonLoader();
      await fetchRankings();
      const response = await fetch(`${googleSheetURL}&cachebuster=${Date.now()}`);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const text = await response.text();
      allData = parseCSV(text);
      groupDataByEvent(allData);
      populateEventDropdown();
      renderAll();
      updateStickyOffsets(); // in case heights shift after render
    } catch (error) {
      console.error("Error fetching data:", error);
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">Failed to load data.</td></tr>';
    }
  }

  async function fetchRankings() {
    try {
      const response = await fetch(`${googleRankingsURL}&cachebuster=${Date.now()}`);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const text = await response.text();
      const rankingsData = parseCSV(text);
      rankingsMap = rankingsData.reduce((acc, current) => {
        const playerName = current['Player'];
        const playerRank = parseInt(current['Rank'], 10);
        if (playerName && !isNaN(playerRank)) acc[playerName] = playerRank;
        return acc;
      }, {});
      playerIconMap = rankingsData.reduce((acc, current) => {
        const playerName = current['Player'];
        const playerIconUrl = current['Player Icon'];
        if (playerName && playerIconUrl) acc[playerName] = playerIconUrl;
        return acc;
      }, {});
    } catch (error) {
      console.error("Error fetching rankings data:", error);
    }
  }

  function renderAll() {
    let dataToRender = [];
    if (searchTerm) {
      const keywords = searchTerm.toLowerCase().split(' ').filter(k => k);
      dataToRender = allData.filter(item => {
        const eventName = (item.Event || '').toLowerCase();
        const playerName = (item.Player || '').toLowerCase();
        return keywords.every(keyword => eventName.includes(keyword) || playerName.includes(keyword));
      });
    } else {
      const currentEventName = uniqueEvents[currentEventIndex];
      dataToRender = groupedDataByEvent[currentEventName] || [];
    }

    const headerElement = document.querySelector(`#tournament-results-table [data-column-name="${sortedColumn}"]`);
    const sortedType = headerElement ? headerElement.getAttribute('data-type') : 'string';

    const sortedData = sortData(dataToRender, sortedColumn, sortedType, sortDirection);
    renderTable(sortedData);
    updatePaginationControls(sortedData.length);
    updateHeaderIcons();
  }

  function renderTable(fullData) {
    let dataToDisplay = fullData;
    const isMobile = window.innerWidth < 769;

    if (isMobile && !searchTerm) {
      dataToDisplay = fullData.slice(0, visiblePlayers);
    }

    tableBody.innerHTML = '';
    if (!dataToDisplay || dataToDisplay.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No results found.</td></tr>';
      return;
    }

    dataToDisplay.forEach(item => {
      const row = document.createElement('tr');
      const playerText = item.Player || '';
      const playerRank = rankingsMap[playerText];
      const playerPhotoUrl = playerIconMap[playerText];

      if (playerRank >= 1 && playerRank <= 5) {
        row.classList.add(`rank-${playerRank}`);
      } else if (playerRank >= 6 && playerRank <= 40) {
        row.classList.add('ranked-6-40');
      }

      let rankIndicatorHtml = '';
      if (playerRank >= 1 && playerRank <= 5) {
        rankIndicatorHtml = `<span class="rank-badge rank-badge--top5">#${playerRank}</span>`;
      } else if (playerRank >= 6 && playerRank <= 40) {
        rankIndicatorHtml = `<span class="rank-badge">#${playerRank}</span>`;
      }

      const showRealPhoto = (playerRank >= 1 && playerRank <= 40 && playerPhotoUrl);
      const playerPhotoHtml = showRealPhoto
        ? `<img src="${playerPhotoUrl}" alt="${playerText}" class="player-icon" onerror="this.style.display='none'">`
        : `<div class="player-placeholder-icon"><i class="fas fa-user"></i></div>`;

      let eventHtml = item.Event || '';
      let playerHtml = playerText;

      if (searchTerm) {
        const regex = new RegExp(searchTerm.split(' ').filter(k => k).join('|'), 'gi');
        eventHtml = eventHtml.replace(regex, match => `<mark>${match}</mark>`);
        playerHtml = playerHtml.replace(regex, match => `<mark>${match}</mark>`);
      }

      const playerContent = `
        <div class="player-cell-content">
          ${playerPhotoHtml}
          ${rankIndicatorHtml}
          <span>${playerHtml}</span>
        </div>
      `;

      row.innerHTML = `
  <td data-label="Event" class="event-cell expandable-cell"><span>${eventHtml}</span></td>
  <td data-label="Date" class="cell-hidden-mobile">${formatDate(item.Date)}</td>
  <td data-label="Entrants" class="cell-hidden-mobile">${item.Entrants || ''}</td>
  <td data-label="Player" class="cell-player">${playerContent}</td>
  <td data-label="Finish">${item.Finish || ''}</td>
`;
      tableBody.appendChild(row);
    });
  }

  function updateHeaderIcons() {
    const headers = document.querySelectorAll('#tournament-results-table th, #results-mobile-sort .btn');
    headers.forEach(header => {
      const columnName = header.getAttribute('data-column-name');
      header.classList.remove('sorted', 'asc', 'desc');
      if (columnName === sortedColumn) {
        header.classList.add('sorted', sortDirection);
      }
    });
  }

  function updatePaginationControls(totalResultsInEvent) {
    const isMobile = window.innerWidth < 769;

    if (searchTerm) {
      stickyPrevBtn.disabled = true;
      stickyNextBtn.disabled = true;
      eventDropdown.disabled = true;

      const searchOption = document.createElement('option');
      searchOption.textContent = `Found ${totalResultsInEvent} results...`;
      eventDropdown.innerHTML = '';
      eventDropdown.appendChild(searchOption);
      if (loadMoreBtn) loadMoreBtn.style.display = 'none';

    } else {
      stickyPrevBtn.disabled = false;
      stickyNextBtn.disabled = false;
      eventDropdown.disabled = false;

      populateEventDropdown();
      eventDropdown.value = currentEventIndex;

      const isFirstEvent = currentEventIndex === 0;
      const isLastEvent = currentEventIndex >= uniqueEvents.length - 1;

      stickyPrevBtn.disabled = isFirstEvent;
      stickyNextBtn.disabled = isLastEvent;

      if (loadMoreBtn && isMobile) {
        const canLoadMore = visiblePlayers < totalResultsInEvent;
        loadMoreBtn.style.display = canLoadMore ? 'inline-flex' : 'none';
      } else if (loadMoreBtn) {
        loadMoreBtn.style.display = 'none';
      }
    }
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;
    const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' };
    return date.toLocaleDateString('en-US', options);
  }

  function scrollToTableTop() {
    const tableWrapper = document.querySelector('.table-wrapper');
    const contentArea = document.querySelector('.content');
    if (!tableWrapper || !contentArea) return;

    const isContentScrollable = getComputedStyle(contentArea).overflowY === 'auto';
    const scrollableElement = isContentScrollable ? contentArea : window;

    let targetPosition;
    if (isContentScrollable) {
      targetPosition = tableWrapper.offsetTop - 100;
    } else {
      const mobileHeader = document.querySelector('.mobile-header');
      const tournamentNav = document.querySelector('.tournament-nav');
      let headerOffset = 15;
      if (mobileHeader) headerOffset += mobileHeader.offsetHeight;
      if (tournamentNav) headerOffset += tournamentNav.offsetHeight;

      const elementPosition = tableWrapper.getBoundingClientRect().top + window.scrollY;
      targetPosition = elementPosition - headerOffset;
    }

    scrollableElement.scrollTo({ top: targetPosition, behavior: 'smooth' });
  }

  function parseCSV(text) {
    const rows = text.trim().split('\n');
    if (rows.length <= 1) return [];
    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
    return rows.slice(1).map(rowStr => {
      const values = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
      const rowData = {};
      headers.forEach((header, i) => {
        rowData[header] = values[i] ? values[i].replace(/^"|"$/g, '').trim() : '';
      });
      return rowData;
    }).filter(row => row.Player && row.Player.trim() !== '');
  }

  function groupDataByEvent(data) {
    const grouped = {};
    const eventDates = {};
    data.forEach(row => {
      const eventName = row.Event;
      if (eventName) {
        if (!grouped[eventName]) {
          grouped[eventName] = [];
          eventDates[eventName] = new Date(row.Date);
        }
        grouped[eventName].push(row);
      }
    });
    groupedDataByEvent = grouped;
    uniqueEvents = Object.keys(grouped).sort((a, b) => eventDates[b] - eventDates[a]);
  }

  const sortableHeaders = document.querySelectorAll('#tournament-results-table th, #results-mobile-sort .btn');
  sortableHeaders.forEach(header => {
    header.addEventListener('click', () => {
      const columnName = header.getAttribute('data-column-name');
      if (sortedColumn === columnName) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortedColumn = columnName;
        sortDirection = (columnName === 'Entrants' || columnName === 'Date') ? 'desc' : 'asc';
      }
      renderAll();
    });
  });

  const setupCardExpansion = (tableElement) => {
    if (tableElement && tableElement.querySelector('tbody')) {
      tableElement.querySelector('tbody').addEventListener('click', (event) => {
        if (event.target.closest('a')) { return; }
        const clickedRow = event.target.closest('tr');
        if (clickedRow) {
          clickedRow.classList.toggle('is-expanded');
        }
      });
    }
  };
  setupCardExpansion(tournamentTable);

  searchInput.addEventListener('input', debounce((e) => {
    searchTerm = e.target.value.toLowerCase();
    renderAll();
  }, 300));

  eventDropdown.addEventListener('change', () => {
    visiblePlayers = playersPerLoad;
    currentEventIndex = parseInt(eventDropdown.value, 10);
    renderAll();
    scrollToTableTop();
  });

  const handlePrevClick = () => {
    if (currentEventIndex > 0) {
      visiblePlayers = playersPerLoad;
      currentEventIndex--;
      renderAll();
      scrollToTableTop();
    }
  };

  const handleNextClick = () => {
    if (currentEventIndex < uniqueEvents.length - 1) {
      visiblePlayers = playersPerLoad;
      currentEventIndex++;
      renderAll();
      scrollToTableTop();
    }
  };

  if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', () => {
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = 'Loading...';
      visiblePlayers += playersPerLoad;
      setTimeout(() => {
        renderAll();
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Load More';
      }, 100);
    });
  }

  stickyPrevBtn.addEventListener('click', handlePrevClick);
  stickyNextBtn.addEventListener('click', handleNextClick);

  fetchData();
});
</script>
{% endblock %}
